blog2(
[
  {
    "time": "2020-08-15",
    "title": "nodejs+微信小程序订阅消息之原理篇",
    "sign": ["node.js","小程序"],
    "content": "    本篇主要使用nodejs启动服务来发送一条小程序通知消息，我们知道原有的小程序模板消息接口已于2020年1月10日下线，所以我们用小程序的订阅消息接口实现消息的推送。本篇文章主要讲发送消息的原理。从0开始让你的小程序收到一条推送服务。首先我们进入微信公众平台-小程序-功能-订阅消息，然后创建一个模板，创建完模板成后查看详情如下：<img class=\"full-img\" src=\"./assets/img/blog/2020-2021/2020081501.png\" />    接着介绍一下订阅消息类型：一次性订阅消息和长期性订阅消息\n    1.一次性订阅消息：用户订阅一次后，开发者可下发一条消息，不限时间。若用户勾选了“总是保持以上选择，不再询问”且点击了允许，那么以后都默认同意订阅这条消息。用户不再做多次选择，开发者也避免了更繁琐的提醒。\n    2.长期性订阅消息：用户订阅一次后，可长期下发多条消息。目前长期性订阅消息向政务、医疗、交通、金融、教育等线下公共服务开放，后续将综合评估行业需求和用户体验持续完善。（长期订阅消息只针对特定行业开放，所以普通开发者并无法使用）\n    我们在小程序调用如下：<code class=\"language-javascript\">  wx.requestSubscribeMessage({\n    tmplIds: ['BDhL9uvqmXxzp-L5_lncb2HZ4cujUgQxoiXHxLDqBuk'],\n    success: (res) => {\n      console.log(res)\n    }\n  })</code>      用户点击允许后方可接收消息。然后我们来获取js_code:<code class=\"language-javascript\">  //app.js\n  App({\n    onLaunch: function() {\n      wx.login({\n        success: function(res) {\n          if (res.code) {\n            let js_code = res.code\n          } else {\n            console.log('获取用户登录态失败！' + res.errMsg)\n          }\n        }\n      });\n    }\n  })</code>    接着我们搭建一个node服务调用推送消息的接口，代码如下:<code class=\"language-javascript\">  /*\n   * 小程序发送模板消息\n   * */\n  const express = require('express');\n  const app = express();\n  const request = require('request');\n  const appId = 'wx1cb2c2c073811';\n  const appSecret = '5b7d6692ee7f1490fffbe65cef3d3';\n  const server = app.listen(8087,function(){\n    //获取access_token\n    request('https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='+appId+'&secret='+appSecret,function(error,response,body){\n      if (!error && response.statusCode === 200) {\n        let bodyJson = JSON.parse(body);\n        let requestData = {\n          touser: 'oDxsZ41LjRdxjiUcpnTyQ45o',  //要通知的用户的openID\n          template_id: \"BDhL9uvqmXxzp-L5_lncb2HZ4cujUgQxXHxLDqBuk\",  //模板id\n          data: {  //要通知的模板数据\n            \"name1\": {\"value\":\"wuufeii\"},\n            \"time2\": {\"value\":\"2020-08-15 18:00\"},\n            \"thing3\": {\"value\":\"您有新消息未读，请点击查看\"},\n            \"thing4\": {\"value\":\"wuufeii给您送了一声祝福：心想事成\"}\n          }\n        };\n        request({  //调用接口进行消息发送\n          url: 'https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token='+bodyJson.access_token,\n          method: 'POST',\n          json: true,\n          headers: {\n            \"content-type\": \"application/json\",\n          },\n          body: requestData,\n        },function(error2,response2,body2){\n          if (!error2 && response2.statusCode == 200) {\n            console.log(body2,'发送消息返回的参数')\n          }\n        })\n      }\n    })\n  })</code>    启动服务，你会在手机上收到一条消息，结果如下:<img src=\"./assets/img/blog/2020-2021/2020081502.png\" />    注意，本篇只讲原理，所以上文中的appId、appSecret、touser、template_id这些都是写的固定值。解释下上面两个接口的作用:\n    第一个接口：https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='+appId+'&secret='+appSecret。它的作用是获取access_token，它需要传入grant_type 、appid和secret，grant_type值为client_credential，appid和secret这两个是小程序ID和密钥，在小程序后台都能查看，这里不细讲。这个接口的<a href=\"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html\" target=”_blank”>官方地址请查看</a>\n    第二个接口：https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token='+bodyJson.access_token。它的作用是发送消息，它需要第一个接口获取到的access_token，并且它还需要传入参数touser(用户openid)、template_id（模板id）、data(模板中对应的字段)，后两个都好说，至于openid怎么获取，我们可以在浏览器上访问下面这个接口： https://api.weixin.qq.com/sns/jscode2session?appid=xxx&secret=xxx&js_code=xxx&grant_type=authorization_code。当然需要改上面为xxx的参数。"
  }
])
